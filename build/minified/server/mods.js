var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,d){a!=Array.prototype&&a!=Object.prototype&&(a[b]=d.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};
$jscomp.Symbol=function(){var a=0;return function(b){return $jscomp.SYMBOL_PREFIX+(b||"")+a++}}();$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.asyncIterator;a||(a=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};
$jscomp.iteratorFromArray=function(a,b){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var d=0,c={next:function(){if(d<a.length){var e=d++;return{value:b(e,a[e]),done:!1}}c.next=function(){return{done:!0,value:void 0}};return c.next()}};c[Symbol.iterator]=function(){return c};return c};
$jscomp.polyfill=function(a,b,d,c){if(b){d=$jscomp.global;a=a.split(".");for(c=0;c<a.length-1;c++){var e=a[c];e in d||(d[e]={});d=d[e]}a=a[a.length-1];c=d[a];b=b(c);b!=c&&null!=b&&$jscomp.defineProperty(d,a,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");
$jscomp.findInternal=function(a,b,d){a instanceof String&&(a=String(a));for(var c=a.length,e=0;e<c;e++){var f=a[e];if(b.call(d,f,e,a))return{i:e,v:f}}return{i:-1,v:void 0}};$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,d){return $jscomp.findInternal(this,a,d).v}},"es6","es3");function scanRecursiveMod(a,b,d){"string"===typeof d&&(b=a+d);if("object"===typeof d)for(var c in d)c in b||(b[c]={}),b[c]=scanRecursiveMod(a,b[c],d[c]);return b}
function isRebuildRequired(){return fileIO.exist("user/cache/db.json")&&fileIO.exist("user/cache/res.json")?!1:!0}
function scanRecursiveRoute(a,b){if("db/"!=a||fileIO.exist("db/")){b={};for(var d=utility.getDirList(a),c=fileIO.readDir(a),e=$jscomp.makeIterator(d),f=e.next();!f.done;f=e.next()){f=f.value;for(var h in c)c[h]===f&&c.splice(h,1)}for(var g in c)h=c[g].split(".").slice(0,-1).join("."),b[h]=a+c[g];g=$jscomp.makeIterator(d);for(d=g.next();!d.done;d=g.next())d=d.value,b[d]=scanRecursiveRoute(a+d+"/");return b}}
function routeDatabaseAndResources(){logger.logInfo("Rebuilding cache: route database");db=scanRecursiveRoute("db/");logger.logInfo("Rebuilding cache: route resources");res=scanRecursiveRoute("res/");res.bundles={files:[],folders:[]};var a=fileIO.readDir("res/bundles",!0).filter(function(a){return a.toLowerCase().endswith(".bundle")}).map(function(a){return internal.path.resolve("res/bundles",a)});res.bundles.files=res.bundles.files.concat(a);db.user={configs:{server:"user/configs/server.json"},events:{schedule:"user/events/schedule.json"}};
fileIO.write("user/cache/db.json",db);fileIO.write("user/cache/res.json",res)}function SortedModKeys(){return Object.keys(global.mods.toLoad).sort(function(a,b){return global.mods.toLoad[a].order>global.mods.toLoad[b].order?1:-1})}
function loadMod(a){var b=SortedModKeys(),d={};b=$jscomp.makeIterator(b);for(var c=b.next();!c.done;d={modFolder:d.modFolder},c=b.next())if(c=c.value,global.mods.toLoad[c].isEnabled)if(d.modFolder=global.mods.toLoad[c].folder,c=fileIO.readParsed("user/mods/"+d.modFolder+"/mod.config.json"),"ResModLoad"==a)"undefined"!=typeof c.res&&(res=scanRecursiveMod("user/mods/"+d.modFolder+"/",res,c.res));else for(var e in c.src)if(c.src[e]==a){if(c.res&&c.res.bundles&&!c.res.bundles.loaded){if(c.res.bundles.folders){var f=
c.res.bundles.folders.map(function(a){return function(b){return internal.path.resolve("user/mods/"+a.modFolder,b)}}(d));res.bundles.folders=res.bundles.folders.concat(f)}c.res.bundles.files&&(f=c.res.bundles.files.map(function(a){return function(b){return internal.path.resolve("user/mods/"+a.modFolder,b)}}(d)),res.bundles.files=res.bundles.files.contcat(f));c.res.bundles.loaded=!0}require("../../user/mods/"+d.modFolder+"/"+e).mod(c)}}exports.CacheModLoad=function(){loadMod("CacheModLoad")};
exports.ResModLoad=function(){loadMod("ResModLoad")};exports.TamperModLoad=function(){loadMod("TamperModLoad")};var ModLoader=function(){this.modsConfig={};this.modsRequirements={};this.orderNumber=1;this.AlreadyQueriedMods=[]};
ModLoader.prototype.modsFileNotFound=function(){var a=fileIO.readDir("user/mods").filter(function(a){return fileIO.lstatSync("user/mods/"+a).isDirectory()});a=$jscomp.makeIterator(a);for(var b=a.next();!b.done;b=a.next()){b=b.value;fileIO.exist("user/mods/"+b+"/mod.config.json")||logger.logWarning("Missing file: mod.config.json. Skipping loading mod: "+b);fileIO.exist("user/mods/"+b+"/package.json")&&fileIO.exist("user/mods/"+b+"/package.js")&&logger.logWarning("Invalid mod: this mod structure is incorrect (its AKI mod). Skipping loading mod: "+
b);var d=fileIO.readParsed("user/mods/"+b+"/mod.config.json");if("undefined"!=typeof d.name&&"string"==typeof d.name)if("undefined"!=typeof d.author&&"string"==typeof d.author)if("undefined"!=typeof d.version&&"string"==typeof d.version)if("undefined"!=typeof d.required&&"object"==typeof d.required)if("undefined"!=typeof d.src&&"object"==typeof d.src){var c=d.name+"-"+d.version+"_"+d.author;this.modsConfig[c]={isEnabled:!0,folder:b,order:-1};this.modsRequirements[c]=d.required}else logger.logWarning('Missing config key: "src" for a mod '+
b+" is missing. Skipping loading mod: "+b);else logger.logWarning('Missing config key: "required" for a mod '+b+" is missing. Skipping loading mod: "+b);else logger.logWarning('Missing config key: "version" is missing or its not a string. Skipping loading mod: '+b);else logger.logWarning('Missing config key: "author" is missing or its not a string. Skipping loading mod: '+b);else logger.logWarning('Missing config key: "name" is missing or its not a string. Skipping loading mod: '+b)}fileIO.write("user/configs/mods.json",
this.modsConfig)};
ModLoader.prototype.modsFileFound=function(){this.modsConfig=fileIO.readParsed("user/configs/mods.json");for(var a in this.modsConfig){var b=this.modsConfig[a];if(b.isEnabled){if(!fileIO.exist("user/mods/"+b.folder)){logger.logWarning("Could not find the mod on disk for "+a+". Assuming it was removed...");delete this.modsConfig[a];return}b=fileIO.readParsed("user/mods/"+b.folder+"/mod.config.json");this.modsRequirements[b.name+"-"+b.version+"_"+b.author]=b.required}}a=fileIO.readDir("user/mods").filter(function(a){return fileIO.lstatSync("user/mods/"+a).isDirectory()});
if(this.modsConfig.length!=a.length)for(logger.logInfo("Detected new mod folders. Trying to add them to the list..."),a=$jscomp.makeIterator(a),b=a.next();!b.done;b=a.next()){b=b.value;var d="user/mods/"+b+"/mod.config.json";if(!fileIO.exist(d)){logger.logError("No mod config found for "+b+". Skipping...");break}var c=void 0;try{c=fileIO.readParsed(d)}catch(e){logger.logError("There was an error reading the mod config for "+b+". Skipping... \nError: "+e.stack);break}d=c.name+"-"+c.version+"_"+c.author;
"undefined"==typeof c[d]&&(this.modsConfig[d]={isEnabled:!0,folder:b,order:-1})}};ModLoader.prototype.queryNoRequirementMods=function(){for(var a in this.modsRequirements)if(0===("undefined"==typeof this.modsRequirements[a]?0:this.modsRequirements[a].length)){var b=fileIO.readParsed("user/mods/"+this.modsConfig[a].folder+"/mod.config.json");this.modsConfig[a].order=this.orderNumber;this.orderNumber++;this.AlreadyQueriedMods.push({name:b.name,ver:b.version});delete this.modsRequirements[a]}};
ModLoader.prototype.queryRequirementMods=function(){var a=this,b=0,d;for(d in this.modsRequirements)b<this.modsRequirements[d].length&&(b=this.modsRequirements[d].length);for(d=1;d<=b;d++){var c={},e;for(e in this.modsRequirements){c.key=e;if(this.modsRequirements[c.key].length===d){for(var f=this.modsRequirements[c.key].length,h={inc:0};h.inc<f;h={inc:h.inc},h.inc++){var g=this.AlreadyQueriedMods.find(function(b,c){return function(d){if(d.name===a.modsRequirements[b.key][c.inc].name)return d}}(c,
h));if("undefined"==typeof g)logger.logWarning("Mod: "+this.modsConfig[c.key].folder+" failed to load due to a missing dependency."),delete this.modsRequirements[c.key],delete this.modsConfig[c.key];else{var l="equal",k=this.modsRequirements[c.key][h.inc].ver;"^"==k.charAt(0)&&(l="newEqual",k=k.substring(1));switch(l){case "equal":g.ver!=k&&(logger.logWarning("Mod: "+this.modsConfig[c.key].folder+" failed to load due to an uncompatible dependency version."),logger.logWarning("Mod version is "+g.ver+
" which is not the required version of "+k+"."),delete this.modsRequirements[c.key],delete this.modsConfig[c.key]);break;case "newEqual":if(g.ver!=k){l=k.split(".");var m=g.ver.split(".");if(l[0]<m[0]||l[1]<m[1]||l[2]<m[2])logger.logWarning("Mod: "+this.modsConfig[c.key].folder+" failed to load due to an uncompatible dependency version."),logger.logWarning("Mod version is "+g.ver+" which is not the required version of "+k+" or newer."),delete this.modsRequirements[c.key],delete this.modsConfig[c.key]}}}}this.modsConfig[c.key].order=
this.orderNumber;this.orderNumber++;this.AlreadyQueriedMods.push({name:this.modsConfig[c.key].name});delete this.modsRequirements[c.key]}c={key:c.key}}}};ModLoader.prototype.sortModsByOrder=function(){var a=this.modsConfig,b=Object.keys(this.modsConfig).sort(function(b,c){return a[b].order>a[c].order?1:-1}),d=[];b=$jscomp.makeIterator(b);for(var c=b.next();!c.done;c=b.next())d.push(this.modsConfig[c.value]);return this.modsConfig=d};
ModLoader.prototype.loadModsData=function(){var a=!1;if(!fileIO.exist("user/configs/mods.json")||serverConfig.rebuildCache)fileIO.write("user/configs/mods.json",{}),a=!0;a?this.modsFileNotFound():this.modsFileFound();global.mods.config=this.modsConfig;this.queryNoRequirementMods();this.queryRequirementMods();global.mods.toLoad=this.modsConfig;fileIO.write("user/configs/mods.json",global.mods.toLoad)};
exports.load=function(){fileIO.exist("user/mods/")||fileIO.mkDir("user/mods/");if(!fileIO.exist("./user/cache")||31>fileIO.readDir("./user/cache").length)logger.logWarning("Missing files! Rebuilding cache required!"),serverConfig.rebuildCache=!0;(new ModLoader).loadModsData();isRebuildRequired()&&!serverConfig.rebuildCache&&(logger.logWarning("Missing db.json or res.json file."),serverConfig.rebuildCache=!0);serverConfig.rebuildCache?(logger.logWarning("Rebuilding cache..."),routeDatabaseAndResources()):
(db=fileIO.readParsed("user/cache/db.json"),res=fileIO.readParsed("user/cache/res.json"))};