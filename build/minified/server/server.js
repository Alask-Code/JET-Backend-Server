var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var c=0;return function(){return c<a.length?{done:!1,value:a[c++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.makeIterator=function(a){var c="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return c?c.call(a):$jscomp.arrayIterator(a)};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,c,b){a!=Array.prototype&&a!=Object.prototype&&(a[c]=b.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(a,c,b,e){if(c){b=$jscomp.global;a=a.split(".");for(e=0;e<a.length-1;e++){var d=a[e];d in b||(b[d]={});b=b[d]}a=a[a.length-1];e=b[a];c=c(e);c!=e&&null!=c&&$jscomp.defineProperty(b,a,{configurable:!0,writable:!0,value:c})}};$jscomp.polyfill("Object.is",function(a){return a?a:function(a,b){return a===b?0!==a||1/a===1/b:a!==a&&b!==b}},"es6","es3");
$jscomp.polyfill("Array.prototype.includes",function(a){return a?a:function(a,b){var c=this;c instanceof String&&(c=String(c));var d=c.length;b=b||0;for(0>b&&(b=Math.max(b+d,0));b<d;b++){var f=c[b];if(f===a||Object.is(f,a))return!0}return!1}},"es7","es3");
$jscomp.checkStringArgs=function(a,c,b){if(null==a)throw new TypeError("The 'this' value for String.prototype."+b+" must not be null or undefined");if(c instanceof RegExp)throw new TypeError("First argument to String.prototype."+b+" must not be a regular expression");return a+""};$jscomp.polyfill("String.prototype.includes",function(a){return a?a:function(a,b){return-1!==$jscomp.checkStringArgs(this,a,"includes").indexOf(a,b||0)}},"es6","es3");
var TarkovSend=function(){this.mime={html:"text/html",txt:"text/plain",jpg:"image/jpeg",png:"image/png",css:"text/css",otf:"font/opentype",json:"application/json"}};TarkovSend.prototype.zlibJson=function(a,c,b){a.writeHead(200,"OK",{"Content-Type":this.mime.json,"content-encoding":"deflate","Set-Cookie":"PHPSESSID="+b});internal.zlib.deflate(c,function(c,b){a.end(b)})};TarkovSend.prototype.txtJson=function(a,c){a.writeHead(200,"OK",{"Content-Type":this.mime.json});a.end(c)};
TarkovSend.prototype.html=function(a,c){a.writeHead(200,"OK",{"Content-Type":this.mime.html});a.end(c)};TarkovSend.prototype.file=function(a,c){var b=c.split("."),e=this.mime[b[b.length-1]]||this.mime.txt,d=fileIO.createReadStream(c);d.on("open",function(){a.setHeader("Content-Type",e);d.pipe(a)})};
var Server=function(){this.tarkovSend=new TarkovSend;this.buffers={};this.name=serverConfig.name;this.ip=serverConfig.ip;this.port=serverConfig.port;this.backendUrl="https://"+this.ip+":"+this.port;this.second_backendUrl="https://"+serverConfig.ip_backend+":"+this.port;this.version="1.2.0";this.createCache();this.createCallback()};
Server.prototype.createCache=function(){this.cacheCallback={};var a=fileIO.readDir("./src/cache");a=$jscomp.makeIterator(a);for(var c=a.next();!c.done;c=a.next()){c=c.value;var b="cache"+c.replace(".js","");this.cacheCallback[b]=require("../../src/cache/"+c).cache}logger.logSuccess("Create: Cache Callback")};Server.prototype.createCallback=function(){var a=require("../../src/callbacks.js").callbacks;this.receiveCallback=a.getReceiveCallbacks();this.respondCallback=a.getRespondCallbacks();logger.logSuccess("Create: Receive Callback")};
Server.prototype.resetBuffer=function(a){this.buffers[a]=void 0};Server.prototype.putInBuffer=function(a,c,b){if(void 0===this.buffers[a]||this.buffers[a].allocated!==b)this.buffers[a]={written:0,allocated:b,buffer:Buffer.alloc(b)};a=this.buffers[a];c.copy(a.buffer,a.written,0);a.written+=c.length;return a.written===a.allocated};Server.prototype.getFromBuffer=function(a){return this.buffers[a].buffer};Server.prototype.getName=function(){return this.name};Server.prototype.getIp=function(){return this.ip};
Server.prototype.getPort=function(){return this.port};Server.prototype.getBackendUrl=function(){return null!=this.second_backendUrl?this.second_backendUrl:this.backendUrl};Server.prototype.getVersion=function(){return this.version};
Server.prototype.generateCertificate=function(){var a=internal.resolve(__dirname,"../../user/certs"),c=internal.resolve(a,"cert.pem"),b=internal.resolve(a,"key.pem");if(fileIO.exist(c)&&fileIO.exist(b)){a=fileIO.readParsed(c);var e=fileIO.readParsed(b)}else{fileIO.exist(a)||fileIO.mkDir(a);var d=internal.selfsigned.generate(null,{keySize:2048,days:365,algorithm:"sha256",extensions:[{name:"commonName",cA:!0,value:this.ip+"/"}],pkcs7:!0,clientCertificate:!0,clientCertificateCN:"jdoe"});a=d.cert;e=d.private;
logger.logInfo("Generated self-signed sha256/2048 certificate "+d.fingerprint+", valid 365 days");fileIO.write(c,a,!0);fileIO.write(b,e,!0)}return{cert:a,key:e}};
Server.prototype.sendResponse=function(a,c,b,e){if("/favicon.ico"==c.url)this.tarkovSend.file(b,"res/icon.ico");else if(c.url.includes(".css"))this.tarkovSend.file(b,"res/style.css");else if(c.url.includes("bender.light.otf"))this.tarkovSend.file(b,"res/bender.light.otf");else{if(c.url.includes("/server/config")){var d=router.getResponse(c,e,a);this.tarkovSend.html(b,d,"")}if("/"==c.url)d=home_f.RenderHomePage(),this.tarkovSend.html(b,d,"");else{d="POST"===c.method||"PUT"===c.method?router.getResponse(c,
e,a):router.getResponse(c,"",a);""===d&&(logger.logError("[UNHANDLED]["+c.url+"]"),logger.logData(e),d='{"err": 404, "errmsg": "UNHANDLED RESPONSE: '+c.url+'", "data": null}');for(var f in this.receiveCallback)this.receiveCallback[f](a,c,b,e,d);if(d in this.respondCallback)this.respondCallback[d](a,c,b,e);else this.tarkovSend.zlibJson(b,d,a)}}};
Server.prototype.handleRequest=function(a,c){var b=a.connection.remoteAddress.replace("::ffff:","");b="127.0.0.1"==b?"LOCAL":b;var e=utility.getCookies(a).PHPSESSID,d="undefined"!=typeof e?"["+e+"]":"";"/files"==a.url.substr(0,6)||"/notif"==a.url.substr(0,6)||"/client/game/keepalive"==a.url||"/player/health/sync"==a.url||a.url.includes(".css")||a.url.includes(".otf")||a.url.includes(".ico")||logger.logRequest(a.url,d+"["+b+"] ");"GET"===a.method&&server.sendResponse(e,a,c,"");if("POST"===a.method)a.on("data",
function(b){if("/"==a.url||a.url.includes("/server/config")){b=b.toString();b=b.split("&");var d={},f;for(f in b){var g=b[f].split("=");d[g[0]]=g[1]}server.sendResponse(e,a,c,d)}else internal.zlib.inflate(b,function(b,d){server.sendResponse(e,a,c,"string"!==d&&null!==d&&""!==d?d.toString():"{}")})});if("PUT"===a.method)a.on("data",function(b){if("expect"in a.headers){var d=parseInt(a.headers["content-length"]);server.putInBuffer(a.headers.sessionid,b,d)||c.writeContinue()}}).on("end",function(){var b=
server.getFromBuffer(e);server.resetBuffer(e);internal.zlib.inflate(b,function(b,d){server.sendResponse(e,a,c,"string"!==d&&null!==d&&""!==d?d.toString():"{}")})})};
Server.prototype._serverStart=function(){var a=this,c=this.backendUrl;internal.https.createServer(this.generateCertificate(),function(b,c){a.handleRequest(b,c)}).listen(this.port,this.ip,function(){logger.logSuccess("Server is working at: "+c)}).on("error",function(a){if("linux"===internal.process.platform&&(!internal.process.getuid||0!==internal.process.getuid())&&1024>a.port)logger.throwErr("\u00bb Non-root processes cannot bind to ports below 1024.",">> core/server.server.js line 274");else if("EADDRINUSE"==
a.code)internal.psList().then(function(a){var c=0;a=$jscomp.makeIterator(a);for(var b=a.next();!b.done;b=a.next()){b=b.value;var e=b.name.toLowerCase();-1==e.indexOf("node")&&-1==e.indexOf("server")&&-1==e.indexOf("emu")&&-1==e.indexOf("justemu")||b.pid==internal.process.pid||(logger.logWarning("ProcessID: "+b.pid+" - Name: "+b.name),c++)}0<c&&logger.logError("Please close this process'es before starting this server.")}),logger.throwErr("\u00bb Port "+a.port+" is already in use","");else throw a;
})};Server.prototype.softRestart=function(){logger.logInfo("[SoftRestart]: Reloading Database");require("../../src/database.js").execute();logger.logInfo("[SoftRestart]: Re-initializing");for(var a in global)a.indexOf("_f")==a.length-2&&("object"==typeof global[a].handler&&"function"==typeof global[a].handler.initialize&&global[a].handler.initialize(),"function"==typeof global[a].initialize&&global[a].initialize());logger.logInfo("[SoftRestart]: Reloading TamperMods");global.mods_f.TamperModLoad()};
Server.prototype.start=function(){logger.logInfo("[Warmup]: Cache callbacks...");for(var a in this.cacheCallback)this.cacheCallback[a]();serverConfig.rebuildCache&&global.mods_f.CacheModLoad();global.mods_f.ResModLoad();logger.logInfo("[Warmup]: Loading Database");require("../../src/database.js").execute();for(var c in global)c.indexOf("_f")==c.length-2&&("object"==typeof global[c].handler&&"function"==typeof global[c].handler.initialize&&global[c].handler.initialize(),"function"==typeof global[c].initialize&&
global[c].initialize());global.mods_f.TamperModLoad();logger.logInfo("Starting server...");this._serverStart()};module.exports.server=new Server;